{
  "id": "pN1mPNqUk4RO7fyy",
  "name": "doctoreto",
  "nodes": [
    {
      "parameters": {
        "path": "doctoreto/get-appointment",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        -32
      ],
      "id": "27947902-eaf5-4933-adda-1bb5043af51e",
      "name": "Webhook",
      "webhookId": "be688471-eb2c-4180-b3ab-f9a1ad199384"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.errorMessage }}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        672,
        64
      ],
      "id": "3e7c054b-2341-437f-be31-67c279f9e2bb",
      "name": "wrong data response"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "66a29011-186b-41a9-9272-557cd6490c9e",
              "leftValue": "={{ $json.isValid }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        448,
        -32
      ],
      "id": "2e817320-8843-4633-895b-6f557f21b536",
      "name": "is input valid"
    },
    {
      "parameters": {
        "jsCode": "// Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ„ÛŒÙ† Ø¢ÛŒØªÙ… ÙˆØ±ÙˆØ¯ÛŒ\nconst item = items[0];\nconst body = item.json.body || {};\n\n// Ø§Ø³ØªØ®Ø±Ø§Ø¬ id Ùˆ date Ø§Ø² body ÙˆØ¨â€ŒÙ‡ÙˆÚ©\nconst received_id = body.p24_id;\nconst date_str = body.date;\n\nconst errorMessages = [];\n\n// --- Ø´Ø±ÙˆØ¹ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ---\n\n// 1. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ID\nif (!received_id) {\n  errorMessages.push(\"ID is missing or empty.\");\n}\n\n// 2. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Date\nif (!date_str) {\n  errorMessages.push(\"Date is missing.\");\n} else {\n  const receivedDate = new Date(date_str);\n  \n  // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª ÛŒØ§ Ù†Ù‡\n  if (isNaN(receivedDate.getTime())) {\n    errorMessages.push(\"Invalid date format. Please use a recognizable format like YYYY-MM-DD.\");\n  } else {\n    const now = new Date();\n    \n    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯Ù‡ ÛŒÚ© Ù‡ÙØªÙ‡ Ù‚Ø¨Ù„\n    const oneWeekAgo = new Date();\n    oneWeekAgo.setDate(now.getDate() - 7);\n    \n    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯Ù‡ ÛŒÚ© Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯\n    const oneWeekLater = new Date();\n    oneWeekLater.setDate(now.getDate() + 7);\n\n    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ØªØ§Ø±ÛŒØ® Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ù…Ø¬Ø§Ø² Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯\n    if (!(receivedDate >= oneWeekAgo && receivedDate <= oneWeekLater)) {\n      errorMessages.push(\"Date is not within the allowed range (-1 week to +1 week).\");\n    }\n  }\n}\n\n// --- Ù¾Ø§ÛŒØ§Ù† Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ---\n\n// 3. Ø³Ø§Ø®Øª Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ¯ IF\nif (errorMessages.length > 0) {\n  // Ø§Ú¯Ø± Ø®Ø·Ø§ÛŒÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯\n  item.json.isValid = false;\n  // ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®Ø·Ø§ Ø±Ø§ Ø¨Ù‡ ÛŒÚ© Ù…ØªÙ† ÙˆØ§Ø­Ø¯ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…\n  item.json.errorMessage = \"Validation failed: \" + errorMessages.join(\" \");\n} else {\n  // Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ú†ÛŒØ² ØµØ­ÛŒØ­ Ø§Ø³Øª\n  item.json.isValid = true;\n  item.json.errorMessage = null;\n}\n\n// Ø¢ÛŒØªÙ… Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ¯ Ø¨Ø¹Ø¯ÛŒ (IF) Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        -32
      ],
      "id": "b377bf13-656d-4f11-97e7-8afc4dbbef7e",
      "name": "validation"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "doctors",
          "mode": "list",
          "cachedResultName": "doctors"
        },
        "where": {
          "values": [
            {
              "column": "p24_id",
              "value": "={{ $json.body.p24_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        -128
      ],
      "id": "ca4f44ca-c2d5-4ac0-8919-a851e74b6adb",
      "name": "find doctor id",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "OGomr8J1QWL5ZbdV",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "0d2221ad-d208-477f-a76f-9c366f7e3194",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        896,
        -128
      ],
      "id": "6150bb5d-c448-4e00-a1f9-d394421d86c9",
      "name": "does dr exists"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "dr does not exist",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1088,
        0
      ],
      "id": "b4edc21e-f2ca-48ef-aa16-9dc1e91ff313",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "url": "=https://api.doctoreto.com/api/web/doctor/v1/orders/turn-date/{{ $('Webhook').item.json.body.date }}?search=[(type+!%3D+4)]&page=1 ",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "accept-language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "app-device",
              "value": "dboJfdAxWU"
            },
            {
              "name": "app-version",
              "value": "2.1.1"
            },
            {
              "name": "origin",
              "value": "https://doctorpanel.doctoreto.com"
            },
            {
              "name": "priority",
              "value": "u=1, i"
            },
            {
              "name": "referer",
              "value": "https://doctorpanel.doctoreto.com/"
            },
            {
              "name": "sec-ch-ua",
              "value": "\"Not;A=Brand\";v=\"99\", \"Google Chrome\";v=\"139\", \"Chromium\";v=\"139\""
            },
            {
              "name": "sec-ch-ua-mobile",
              "value": "?1"
            },
            {
              "name": "sec-ch-ua-platform",
              "value": "\"Android\""
            },
            {
              "name": "sec-fetch-dest",
              "value": "empty"
            },
            {
              "name": "sec-fetch-mode",
              "value": "cors"
            },
            {
              "name": "sec-fetch-site",
              "value": "same-site"
            },
            {
              "name": "user-agent",
              "value": "Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Mobile Safari/537.36"
            },
            {
              "name": "cookie",
              "value": "_gcl_au=1.1.498441742.1752003342;analytics_campaign={%22source%22:%22google%22%2C%22medium%22:%22organic%22};_gid=GA1.2.647465753.1754995560;_clck=1u4a78c%7C2%7Cfye%7C0%7C2015;_ga=GA1.2.1884793141.1752003344;auth_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOi8vYXBpLmRvY3RvcmV0by5jb20vYXBpL3dlYi9wYXRpZW50L3YxL2FjY291bnRzL2xvZ2luIiwiaWF0IjoxNzU1MDE2MzEyLCJleHAiOjE3NTUxMDI3MTcsIm5iZiI6MTc1NTAxNjMxNywianRpIjoiVnZ0Q2Z3M3dwS0JhREYzZiIsInN1YiI6Ijk3NzM2MCIsInBydiI6IjA4MWIwY2RjMjA4M2NkY2MxYTgzNGIwZmZhNWNkMWQ0ZDQ2ZGNlMDEifQ.oHx4EQ3j2w-qD5V0LqzrY3wB6KypmyYb4GvdjZ_gtm0;_ga_WYWKZ71LLD=GS2.1.s1755015944$o11$g1$t1755016319$j12$l0$h0;_clsk=s0ffav%7C1755016322208%7C5%7C0%7Cs.clarity.ms%2Fcollect;chat_auth_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiNjFhMDJlNzk5YjQzMzUwNTJhZjMyMWIwIiwiaWF0IjoxNzU1MDE2MzIwLCJleHAiOjE3NTUxMDI3MjAsImlzcyI6Imh0dHBzOi8vZG9jdG9yZXRvLmNvbSJ9.NPGhfjBfhGIb5R7Qm7jMV429VJVyxT9QPayZNi6osyg;"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1824,
        -304
      ],
      "id": "dabce10e-eb41-4bc4-8fb6-542d8bc9339a",
      "name": "list ",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "fieldToSplitOut": "items",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        2048,
        -480
      ],
      "id": "7a7f9cd2-4d94-40b4-baf5-6c08d18b75b1",
      "name": "Split Out1"
    },
    {
      "parameters": {
        "jsCode": "const runAt = new Date().toISOString();\nconst defaultDoctorId = \"12061\";\n\nreturn items.map(it => {\n  const a = it.json;\n\n  // Ú¯Ø±ÙØªÙ† ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª\n  const scheduledDate = a.context?.shamsi_turn_date || '';\n  const scheduledTime = a.context?.shamsi_turn_time || '';\n\n  // ØªØ¹ÛŒÛŒÙ† Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø± (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù†Ø·Ù‚ Ù…Ù‡Ø±Ø³Ø§Ù… / Ù†ÛŒÚ©Ø±Ø®)\n  let firstname = a.patient?.first_name || '';\n  let lastname = a.patient?.last_name || '';\n  if (a.customer?.full_name && a.customer.full_name !== a.patient?.full_name) {\n    const parts = a.customer.full_name.trim().split(' ');\n    firstname = parts[0] || firstname;\n    lastname = parts.slice(1).join(' ') || lastname;\n  }\n\n  return {\n    json: {\n      run_at: runAt,\n      scheduled_date: scheduledDate.split(' ')[0] || '',\n      scheduled_time: scheduledTime || '',\n      appointment_id: a.id || '',\n      user_patient_id: a.patient?.id || '',\n      firstname,\n      lastname,\n      mobile: a.patient?.user?.mobile?.toString() || a.customer?.mobile?.toString() || '',\n      national_code: a.customer?.national_code || a.patient?.national_code || '',\n      scheduled_from: scheduledDate ? `${scheduledDate} ${scheduledTime}` : '',\n      scheduled_to: '',\n      doctor_id: a.context?.doctor?.id || defaultDoctorId,\n      source_page: '',\n      raw_json: JSON.stringify(a),\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2272,
        -480
      ],
      "id": "43b3d80d-1b39-4959-81a3-f18956b74c70",
      "name": "Code2"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": ""
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        2496,
        -480
      ],
      "id": "27e7f4ac-bfe2-4cea-9931-b5513b7057e7",
      "name": "Append row in sheet1",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const appts = items.map(it => it.json);\nconst count = appts.length;\nconst dateLabel = appts[0]?.scheduled_date || \"Ø§Ù…Ø±ÙˆØ²\";\n\nlet text = 'DOCTORETO\\n\\n';\ntext += `ðŸ“‹ Ù„ÛŒØ³Øª Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ ${dateLabel} â€” ØªØ¹Ø¯Ø§Ø¯: ${count}\\n\\n`;\n\nfor (const a of appts) {\n  let timePart = '';\n  if (a.scheduled_from) {\n    const parts = a.scheduled_from.split(' ');\n    timePart = parts.length > 1 ? `${parts[0]} ${parts[1]}` : a.scheduled_from;\n  }\n  text += `${a.firstname} ${a.lastname} â€” ${a.mobile || '-'} â€” ${timePart}\\n`;\n}\n\nreturn [{ json: { message: text } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2720,
        -480
      ],
      "id": "0020d2aa-8c27-4298-8026-dfc756405a7b",
      "name": "Code3"
    },
    {
      "parameters": {
        "chatId": "1999634605",
        "text": "={{ $json.message }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2944,
        -480
      ],
      "id": "d078e22f-7ef0-4682-b122-a53d862c6f0c",
      "name": "Send a text message1",
      "webhookId": "e1e03ccc-2805-4408-8096-0f20916b03fe",
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "doctoreto has error",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2032,
        -208
      ],
      "id": "c58480e9-930f-4397-b360-e244ab8fc172",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "content": "get doctro connection data\n",
        "height": 384,
        "width": 736
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1104,
        -384
      ],
      "typeVersion": 1,
      "id": "adf8df87-af91-4fb2-b6ff-274ce10d9888",
      "name": "Sticky Note"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is input valid": {
      "main": [
        [
          {
            "node": "find doctor id",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "wrong data response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validation": {
      "main": [
        [
          {
            "node": "is input valid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "find doctor id": {
      "main": [
        [
          {
            "node": "does dr exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "does dr exists": {
      "main": [
        [],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "list ": {
      "main": [
        [
          {
            "node": "Split Out1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out1": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Append row in sheet1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append row in sheet1": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "triggerCount": 1,
  "versionId": "76f6e0eb-ce71-4876-b84d-c7770bbc8ca6",
  "owner": {
    "type": "team",
    "teamId": "pzvw8g7gyGnUF15Q",
    "teamName": "calendar"
  },
  "parentFolderId": null,
  "isArchived": true
}